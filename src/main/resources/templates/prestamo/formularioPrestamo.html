<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Registrar Préstamo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        .search-results {
            position: absolute;
            z-index: 1000;
            width: 100%;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        /* CORRECCIÓN VISUAL: Flexbox para alinear texto izquierda y badge derecha */
        .search-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex; /* Bootstrap d-flex */
            justify-content: space-between; /* Texto a los extremos */
            align-items: center; /* Centrado vertical */
        }

        .search-item:hover {
            background-color: #f8f9fa;
        }

        /* Estilo para items bloqueados */
        .search-item.disabled-item {
            background-color: #f8d7da; /* Fondo rojo claro */
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .search-item.warning-item {
            background-color: #fff3cd; /* Fondo amarillo claro */
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div th:replace="fragments/header :: navbar"></div>

    <div class="container mt-4">
        <h2 class="mb-4 text-success">Registrar Nuevo Préstamo</h2>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <form th:action="@{/prestamos/guardar}" th:object="${prestamoDTO}" method="post" autocomplete="off">

            <div class="row">
                <div class="col-md-6 mb-3 position-relative">
                    <label for="socioSearch" class="form-label">Buscar Socio:</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-search"></i></span>
                        <input type="text" id="socioSearch" class="form-control" placeholder="Nombre o DNI..." required>
                        <span class="input-group-text bg-white border-start-0" id="socioSpinner" style="display:none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </span>
                        <button class="btn btn-outline-secondary" type="button" onclick="limpiarSeleccion('socio')"><i class="bi bi-x"></i></button>
                    </div>
                    <input type="hidden" id="socioId" th:field="*{socioId}">
                    <div id="listaSocios" class="search-results"></div>
                </div>

                <div class="col-md-6 mb-3 position-relative">
                    <label for="libroSearch" class="form-label">Buscar Libro:</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-book"></i></span>
                        <input type="text" id="libroSearch" class="form-control" placeholder="Título o Autor..." required>
                        <span class="input-group-text bg-white border-start-0" id="libroSpinner" style="display:none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </span>
                        <button class="btn btn-outline-secondary" type="button" onclick="limpiarSeleccion('libro')"><i class="bi bi-x"></i></button>
                    </div>
                    <input type="hidden" id="libroId" th:field="*{libroId}">
                    <div id="listaLibros" class="search-results"></div>
                </div>
            </div>

            <p class="text-muted mt-3"><i class="bi bi-info-circle"></i> Reglas: Máximo 2 préstamos activos. Socios con deudas no pueden retirar libros.</p>
            <hr class="my-4">

            <button type="submit" class="btn btn-success me-2" id="btnGuardar">
                <i class="bi bi-calendar-plus"></i> Confirmar Préstamo
            </button>
            <a th:href="@{/prestamos}" class="btn btn-secondary"><i class="bi bi-list"></i> Volver</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function limpiarSeleccion(tipo) {
            document.getElementById(tipo + 'Search').value = '';
            document.getElementById(tipo + 'Id').value = '';
            document.getElementById(tipo + 'Search').classList.remove('is-valid', 'is-invalid');
            document.getElementById(tipo + 'Spinner').style.display = 'none';
        }

        function setupAutocomplete(inputId, listId, hiddenId, spinnerId, urlApi, type) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const hidden = document.getElementById(hiddenId);
            const spinner = document.getElementById(spinnerId);

            const realizarBusqueda = debounce(function (query) {
                if (query.length < 2) { list.style.display = 'none'; spinner.style.display = 'none'; return; }

                fetch(`${urlApi}?query=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        spinner.style.display = 'none';
                        list.innerHTML = '';

                        if (data.length === 0) {
                            list.innerHTML = '<div class="search-item text-muted justify-content-center">No se encontraron resultados</div>';
                        }

                        data.forEach(item => {
                            const div = document.createElement('div');
                            
                            let contentLeft = `<strong>${item.texto}</strong>`;
                            let badgeHtml = '';
                            let isBlocked = false;

                            // Lógica para LIBROS
                            if (type === 'libro') {
                                if (item.stock > 0) {
                                    badgeHtml = `<span class="badge bg-success rounded-pill">Stock: ${item.stock}</span>`;
                                } else {
                                    isBlocked = true;
                                    div.classList.add('disabled-item');
                                    badgeHtml = `<span class="badge bg-danger rounded-pill">Sin Stock</span>`;
                                }
                            } 
                            // Lógica para SOCIOS
                            else if (type === 'socio') {
                                if (item.moroso) {
                                    isBlocked = true;
                                    div.classList.add('disabled-item');
                                    badgeHtml = `<span class="badge bg-danger">MOROSO</span>`;
                                } else if (item.activos >= 2) {
                                    isBlocked = true;
                                    div.classList.add('warning-item');
                                    badgeHtml = `<span class="badge bg-warning text-dark">Límite (2/2)</span>`;
                                } else {
                                    badgeHtml = `<span class="badge bg-primary">Activos: ${item.activos}/2</span>`;
                                }
                            }

                            div.className = 'search-item';
                            // Insertamos el HTML estructurado
                            div.innerHTML = `<span>${contentLeft}</span> ${badgeHtml}`;

                            if (!isBlocked) {
                                div.addEventListener('click', function () {
                                    input.value = item.texto.split(' - ')[0];
                                    hidden.value = item.id;
                                    list.style.display = 'none';
                                    input.classList.add('is-valid');
                                    input.classList.remove('is-invalid');
                                });
                            }

                            list.appendChild(div);
                        });
                        list.style.display = 'block';
                    });
            }, 300);

            input.addEventListener('input', function () {
                const query = this.value;
                if(query === '') { hidden.value = ''; input.classList.remove('is-valid'); }
                if (query.length >= 2) spinner.style.display = 'block';
                else { list.style.display = 'none'; spinner.style.display = 'none'; }
                realizarBusqueda(query);
            });

            document.addEventListener('click', function (e) {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Pasamos 'socio' o 'libro' como último parámetro para saber qué lógica aplicar
            setupAutocomplete('socioSearch', 'listaSocios', 'socioId', 'socioSpinner', '/api/busqueda/socios', 'socio');
            setupAutocomplete('libroSearch', 'listaLibros', 'libroId', 'libroSpinner', '/api/busqueda/libros', 'libro');

            document.querySelector('form').addEventListener('submit', function(e) {
                if(!document.getElementById('socioId').value || !document.getElementById('libroId').value) {
                    e.preventDefault();
                    alert("Seleccione opciones válidas de la lista.");
                }
            });
        });
    </script>
</body>
</html>